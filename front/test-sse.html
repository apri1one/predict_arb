<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE æ•°æ®æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .timestamp {
            color: #888;
            font-size: 12px;
        }
        .connected { color: #00ff00; }
        .disconnected { color: #ff0000; }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Dashboard SSE æ•°æ®æµ‹è¯•</h1>

    <div class="section">
        <div class="title">è¿æ¥çŠ¶æ€</div>
        <div id="status" class="disconnected">æœªè¿æ¥</div>
    </div>

    <div class="section">
        <div class="title">å¥—åˆ©æœºä¼š (Opportunity Event)</div>
        <div class="timestamp" id="opp-time">ç­‰å¾…æ•°æ®...</div>
        <pre id="opp-data">-</pre>
    </div>

    <div class="section">
        <div class="title">ç»Ÿè®¡æ•°æ® (Stats Event)</div>
        <div class="timestamp" id="stats-time">ç­‰å¾…æ•°æ®...</div>
        <pre id="stats-data">-</pre>
    </div>

    <div class="section">
        <div class="title">è´¦æˆ·æ•°æ® (Accounts Event)</div>
        <div class="timestamp" id="accounts-time">ç­‰å¾…æ•°æ®...</div>
        <pre id="accounts-data">-</pre>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3005';
        let eventSource = null;
        let updateCount = 0;

        function connect() {
            console.log('ğŸ”Œ è¿æ¥ SSE...');
            eventSource = new EventSource(`${API_BASE_URL}/api/stream`);

            eventSource.onopen = () => {
                console.log('âœ… SSE å·²è¿æ¥');
                document.getElementById('status').textContent = 'å·²è¿æ¥';
                document.getElementById('status').className = 'connected';
            };

            eventSource.onerror = (e) => {
                console.error('âŒ SSE é”™è¯¯:', e);
                document.getElementById('status').textContent = 'è¿æ¥é”™è¯¯';
                document.getElementById('status').className = 'disconnected';
            };

            // ç›‘å¬ opportunity äº‹ä»¶
            eventSource.addEventListener('opportunity', (e) => {
                updateCount++;
                const data = JSON.parse(e.data);
                const timestamp = new Date().toLocaleTimeString();

                document.getElementById('opp-time').textContent =
                    `æœ€åæ›´æ–°: ${timestamp} (#${updateCount})`;
                document.getElementById('opp-data').textContent =
                    JSON.stringify(data, null, 2);

                console.log(`ğŸ“Š Opportunity æ›´æ–° #${updateCount}:`, data);
            });

            // ç›‘å¬ stats äº‹ä»¶
            eventSource.addEventListener('stats', (e) => {
                const data = JSON.parse(e.data);
                const timestamp = new Date().toLocaleTimeString();

                document.getElementById('stats-time').textContent =
                    `æœ€åæ›´æ–°: ${timestamp}`;
                document.getElementById('stats-data').textContent =
                    JSON.stringify(data, null, 2);

                console.log('ğŸ“ˆ Stats æ›´æ–°:', data);
            });

            // ç›‘å¬ accounts äº‹ä»¶
            eventSource.addEventListener('accounts', (e) => {
                const data = JSON.parse(e.data);
                const timestamp = new Date().toLocaleTimeString();

                document.getElementById('accounts-time').textContent =
                    `æœ€åæ›´æ–°: ${timestamp}`;
                document.getElementById('accounts-data').textContent =
                    JSON.stringify(data, null, 2);

                console.log('ğŸ’° Accounts æ›´æ–°:', data);
            });
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥
        connect();

        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
